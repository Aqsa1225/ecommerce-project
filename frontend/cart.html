<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShopEasy - Cart</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }

    /* Navbar */
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 2rem;
      background: #131921;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav .logo { font-size: 1.8rem; font-weight: 700; color: #ff9900; }
    nav ul { display: flex; list-style: none; gap: 1.2rem; margin: 0; padding: 0; }
    nav ul li a { color: white; text-decoration: none; font-weight: 500; font-size: 0.95rem; transition: color 0.3s; }
    nav ul li a:hover { color: #febd69; }

    /* Container */
    .container { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
    h2 { text-align: center; color: #1a1f36; margin-bottom: 2rem; font-weight: 700; }

    /* Modern Table */
    table { width: 100%; border-collapse: separate; border-spacing: 0 0.8rem; }
    thead th { background: #1f7aec; color: white; padding: 1rem; border-radius: 8px; font-weight: 600; }
    tbody tr { background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border-radius: 8px; transition: transform 0.2s, box-shadow 0.2s; }
    tbody tr:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(31,122,236,0.15); }
    td { padding: 1rem; text-align: center; vertical-align: middle; }

    /* Quantity input */
    input[type="number"] { width: 60px; padding: 0.4rem; text-align: center; border: 1px solid #ccc; border-radius: 6px; outline: none; transition: all 0.3s ease; }
    input[type="number"]:focus { border-color: #1f7aec; box-shadow: 0 0 6px rgba(31,122,236,0.3); }

    /* Buttons */
    button { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
    tbody button { background: #ff6b35; color: white; }
    tbody button:hover { background: #e65a28; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }

    /* Checkout button */
    .total-container { margin-top: 2rem; display: flex; justify-content: flex-end; align-items: center; gap: 1rem; font-size: 1.3rem; font-weight: 600; flex-wrap: wrap; }
    .checkout-btn { background: linear-gradient(90deg, #1f7aec, #ff6b35); padding: 0.8rem 1.5rem; font-size: 1rem; border-radius: 8px; color: white; font-weight: 700; }
    .checkout-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(31,122,236,0.4); }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background: #fff; margin: 10% auto; padding: 2rem; border-radius: 12px; max-width: 500px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.25); }
    .modal h3 { margin-bottom: 1rem; color: #1a1f36; }
    .close { float: right; font-size: 1.5rem; cursor: pointer; color: #999; }
    .close:hover { color: #333; }

    /* Footer */
    footer { background: #131921; color: white; padding: 2.5rem 2rem; display: flex; flex-wrap: wrap; justify-content: space-between; gap: 2rem; border-top: 4px solid #febd69; }
    footer .footer-section { flex: 1 1 250px; }
    footer h3 { font-size: 1.2rem; margin-bottom: 1rem; color: #febd69; }
    footer ul { list-style: none; padding: 0; }
    footer ul li { margin-bottom: 0.5rem; }
    footer ul li a { color: white; text-decoration: none; font-size: 0.9rem; transition: color 0.3s; }
    footer ul li a:hover { color: #febd69; }
    footer p { font-size: 0.9rem; line-height: 1.5; }
    footer .footer-bottom { width: 100%; text-align: center; margin-top: 2rem; font-size: 0.85rem; border-top: 1px solid #444; padding-top: 1rem; color: #aaa; }

    /* Responsive */
    @media(max-width: 768px){
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tbody tr { margin-bottom: 1rem; }
      td { text-align: right; padding-left: 50%; position: relative; }
      td::before { content: attr(data-label); position: absolute; left: 1rem; font-weight: 600; text-align: left; }
      .total-container { flex-direction: column; align-items: flex-end; }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav>
    <div class="logo">ShopEasy</div>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="login.html">Login</a></li>
      <li><a href="register.html">Register</a></li>
      <li><a href="cart.html">Cart</a></li>
      <li><a href="orders.html">My Orders</a></li>
    </ul>
  </nav>

  <div class="container">
    <h2>Your Cart</h2>
    <table id="cartTable">
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Subtotal</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="cartBody"></tbody>
    </table>
    <div class="total-container">
      <div>Total: $<span id="total">0.00</span></div>
      <button class="checkout-btn" id="checkoutBtn">Checkout</button>
    </div>
  </div>

  <!-- COD Modal -->
  <div id="codModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h3>Confirm Your Order</h3>
      <p>Total Amount: $<span id="modalTotal">0.00</span></p>
      <p>Payment Method: <strong>Cash on Delivery</strong></p>
      <button id="confirmOrderBtn">Place Order</button>
    </div>
  </div>

  <footer>
    <div class="footer-section">
      <h3>About ShopEasy</h3>
      <p>ShopEasy is your one-stop shop for fashion, electronics, and more.</p>
    </div>
    <div class="footer-section">
      <h3>Quick Links</h3>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="cart.html">Cart</a></li>
        <li><a href="login.html">Login</a></li>
        <li><a href="register.html">Register</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h3>Customer Service</h3>
      <ul>
        <li><a href="#">Help Center</a></li>
        <li><a href="#">Returns</a></li>
        <li><a href="#">Shipping Info</a></li>
        <li><a href="#">Contact Us</a></li>
      </ul>
    </div>
    <div class="footer-bottom">&copy; 2025 ShopEasy. All rights reserved.</div>
  </footer>

  <script>
  const cartBody = document.getElementById('cartBody');
  const totalEl = document.getElementById('total');
  const checkoutBtn = document.getElementById('checkoutBtn');
  const codModal = document.getElementById('codModal');
  const closeModal = document.getElementById('closeModal');
  const modalTotal = document.getElementById('modalTotal');
  const confirmOrderBtn = document.getElementById('confirmOrderBtn');
  const token = localStorage.getItem('token');

  // ✅ Update navbar immediately
  checkAuthNavbar();

  if (!token) {
    alert('Please login first.');
    window.location.href = 'login.html';
  }

  async function fetchCart() {
    try {
      const res = await fetch('http://localhost:5000/api/cart', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      if (!res.ok) {
        alert(data.message || 'Failed to load cart.');
        if (res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
        }
        return;
      }
      renderCart(data.items || []);
    } catch (err) {
      console.error(err);
      alert('Failed to load cart.');
    }
  }

  function renderCart(cart) {
    cartBody.innerHTML = '';
    let total = 0;
    if (cart.length === 0) {
      cartBody.innerHTML = '<tr><td colspan="5">Your cart is empty.</td></tr>';
      totalEl.textContent = '0.00';
      modalTotal.textContent = '0.00';
      return;
    }

    cart.forEach(item => {
      if (!item.product) return;
      const subtotal = item.product.price * item.quantity;
      total += subtotal;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td data-label="Product">
          <img src="${item.product.image || 'https://via.placeholder.com/50'}" alt="${item.product.title || 'No Title'}" style="width:50px;height:50px;margin-right:8px;vertical-align:middle;border-radius:6px;">
          ${item.product.title || 'No Title'}
        </td>
        <td data-label="Price">$${item.product.price?.toFixed(2) || '0.00'}</td>
        <td data-label="Quantity">
          <input type="number" min="1" value="${item.quantity}" onchange="updateQuantity('${item.product._id}', this.value)">
        </td>
        <td data-label="Subtotal">$${subtotal.toFixed(2)}</td>
        <td data-label="Action"><button onclick="removeFromCart('${item.product._id}')">Remove</button></td>
      `;
      cartBody.appendChild(row);
    });

    totalEl.textContent = total.toFixed(2);
    modalTotal.textContent = total.toFixed(2);
  }

  async function updateQuantity(productId, quantity) {
    try {
      const res = await fetch(`http://localhost:5000/api/cart/update/${productId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ quantity: Number(quantity) })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Failed to update quantity');
      fetchCart();
    } catch (err) {
      console.error(err);
      alert('Something went wrong updating quantity.');
    }
  }

  async function removeFromCart(productId) {
    try {
      const res = await fetch(`http://localhost:5000/api/cart/remove/${productId}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Failed to remove item');
      fetchCart();
    } catch (err) {
      console.error(err);
      alert('Something went wrong removing item.');
    }
  }

  // Checkout button
  checkoutBtn.addEventListener('click', () => {
    window.location.href = 'checkout.html';
  });

  // Modal events
  closeModal.addEventListener('click', () => { codModal.style.display = 'none'; });
  window.addEventListener('click', (e) => { if (e.target == codModal) codModal.style.display = 'none'; });

  // Confirm COD order
  confirmOrderBtn.addEventListener('click', async () => {
    try {
      const res = await fetch('http://localhost:5000/api/cart/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ paymentMethod: 'COD' })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Failed to place order');
      alert(`✅ Order placed successfully! Order ID: ${data.orderId}`);
      codModal.style.display = 'none';
      fetchCart();
    } catch (err) {
      console.error(err);
      alert('Something went wrong placing order.');
    }
  });

  // ✅ Function to manage navbar links dynamically
  function checkAuthNavbar() {
    const token = localStorage.getItem("token");
    const nav = document.querySelector("nav ul");

    if (!nav) return; // if no nav found, skip

    const loginLink = nav.querySelector('a[href="login.html"]')?.parentElement;
    const registerLink = nav.querySelector('a[href="register.html"]')?.parentElement;
    const logoutLink = nav.querySelector('a[href="#logout"]')?.parentElement;

    if (token) {
      // Hide Login & Register
      if (loginLink) loginLink.style.display = "none";
      if (registerLink) registerLink.style.display = "none";

      // Add Logout if not there
      if (!logoutLink) {
        const li = document.createElement("li");
        const logout = document.createElement("a");
        logout.href = "#logout";
        logout.innerText = "Logout";
        logout.addEventListener("click", () => {
          localStorage.removeItem("token");
          alert("Logged out successfully!");
          window.location.reload();
        });
        li.appendChild(logout);
        nav.appendChild(li);
      }
    } else {
      // Show Login & Register again
      if (loginLink) loginLink.style.display = "block";
      if (registerLink) registerLink.style.display = "block";

      // Remove Logout if exists
      if (logoutLink) logoutLink.remove();
    }
  }

  fetchCart();
</script>


</body>
</html>
