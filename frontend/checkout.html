<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShopEasy - Checkout</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    
    body { font-family: 'Roboto', sans-serif; background: #f2f2f2; margin:0; padding:0; }
    .container { max-width: 800px; margin: 2rem auto; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 2rem;
      background: #131921;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav .logo { font-size: 1.8rem; font-weight: 700; color: #ff9900; }
    nav ul { display: flex; list-style: none; gap: 1.2rem; margin: 0; padding: 0; }
    nav ul li a { color: white; text-decoration: none; font-weight: 500; font-size: 0.95rem; transition: color 0.3s; }
    nav ul li a:hover { color: #febd69; }
    h2 { text-align: center; color: #1a1f36; margin-bottom: 2rem; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.3rem; font-weight: 500; }
    input { width: 100%; padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; }
    .summary { margin-bottom: 2rem; }
    .summary div { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 1rem; align-items: center; }
    .summary div.total { font-weight: bold; font-size: 1.2rem; border-top: 1px solid #ddd; padding-top: 0.5rem; }
    button { padding: 0.7rem 1.2rem; background: #ff6b35; border: none; color: white; border-radius: 5px; cursor: pointer; transition: background 0.3s; font-size: 1rem; }
    button:hover { background: #e65a28; }
    .remove-btn { background: #999; margin-left: 1rem; }
    .remove-btn:hover { background: #666; }
    input[type="number"] { width: 50px; text-align: center; margin-left: 0.5rem; }
    .notification { margin-top: 1rem; padding: 1rem; border-radius: 5px; display: none; font-weight: 500; }
    .notification.success { background: #e6ffe6; color: #2d7a2d; border: 1px solid #2d7a2d; }
    .notification.error { background: #ffe6e6; color: #a12d2d; border: 1px solid #a12d2d; }
    .product-img { width: 50px; height: 50px; margin-right: 8px; border-radius: 6px; vertical-align: middle; }
    .product-name { display: flex; align-items: center; }
    footer { background: #131921; color: white; padding: 2.5rem 2rem; display: flex; flex-wrap: wrap; justify-content: space-between; gap: 2rem; border-top: 4px solid #febd69; }
    footer .footer-section { flex: 1 1 250px; }
    footer h3 { font-size: 1.2rem; margin-bottom: 1rem; color: #febd69; }
    footer ul { list-style: none; padding: 0; }
    footer ul li { margin-bottom: 0.5rem; }
    footer ul li a { color: white; text-decoration: none; font-size: 0.9rem; transition: color 0.3s; }
    footer ul li a:hover { color: #febd69; }
    footer p { font-size: 0.9rem; line-height: 1.5; }
    footer .footer-bottom { width: 100%; text-align: center; margin-top: 2rem; font-size: 0.85rem; border-top: 1px solid #444; padding-top: 1rem; color: #aaa; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav>
    <div class="logo">ShopEasy</div>

    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="login.html">Login</a></li>
      <li><a href="register.html">Register</a></li>
      <li><a href="cart.html">Cart</a></li>
      <li><a href="orders.html">My Orders</a></li>
    </ul>
  </nav>
  <div class="container">
    <h2>Checkout - Cash on Delivery</h2>

    <!-- User Details Form -->
    <div class="user-details">
      <div class="form-group">
        <label for="name">Full Name</label>
        <input type="text" id="name" placeholder="Enter your full name">
      </div>
      <div class="form-group">
        <label for="phone">Phone Number</label>
        <input type="tel" id="phone" placeholder="Enter your phone number">
      </div>
      <div class="form-group">
        <label for="address">Delivery Address</label>
        <input type="text" id="address" placeholder="Enter your full address">
      </div>
    </div>

    <!-- Order Summary -->
    <div class="summary" id="orderSummary"></div>
    <button id="placeOrderBtn">Place Order</button>

    <!-- Notification -->
    <div id="notificationBox" class="notification"></div>
  </div>
<!-- Footer -->
  <footer>
    <div class="footer-section">
      <h3>About ShopEasy</h3>
      <p>ShopEasy is your one-stop shop for fashion, electronics, and more.</p>
    </div>
    <div class="footer-section">
      <h3>Quick Links</h3>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="cart.html">Cart</a></li>
        <li><a href="login.html">Login</a></li>
        <li><a href="register.html">Register</a></li>
      </ul>
    </div>
    <div class="footer-section">
      <h3>Customer Service</h3>
      <ul>
        <li><a href="#">Help Center</a></li>
        <li><a href="#">Returns</a></li>
        <li><a href="#">Shipping Info</a></li>
        <li><a href="#">Contact Us</a></li>
      </ul>
    </div>
    <div class="footer-bottom">&copy; 2025 ShopEasy. All rights reserved.</div>
  </footer>
  <script>
  const orderSummary = document.getElementById('orderSummary');
  const placeOrderBtn = document.getElementById('placeOrderBtn');
  const notificationBox = document.getElementById('notificationBox');
  const token = localStorage.getItem('token');

  // ✅ Update navbar immediately
  checkAuthNavbar();

  if (!token) {
    alert('Please login first.');
    window.location.href = 'login.html';
  }

  let totalPrice = 0;
  let cartItems = [];

  async function fetchCart() {
    try {
      const res = await fetch('http://localhost:5000/api/cart', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();

      if (!res.ok) {
        alert(data.message || 'Failed to load cart.');
        if (res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
        }
        return;
      }

      cartItems = data.items || [];
      renderSummary(cartItems);

    } catch (err) {
      console.error(err);
      alert('Failed to load cart.');
    }
  }

  function renderSummary(cart) {
    orderSummary.innerHTML = '';
    totalPrice = 0;

    if (cart.length === 0) {
      orderSummary.innerHTML = '<p>Your cart is empty.</p>';
      placeOrderBtn.disabled = true;
      return;
    }

    cart.forEach(item => {
      if (!item.product) return;
      const subtotal = item.product.price * item.quantity;
      totalPrice += subtotal;

      const div = document.createElement('div');
      div.innerHTML = `
        <span class="product-name">
          <img src="${item.product.image || 'https://via.placeholder.com/50'}" alt="${item.product.title || 'No Title'}" class="product-img">
          ${item.product.title || 'No Title'} x 
          <input type="number" min="1" value="${item.quantity}" onchange="updateQuantity('${item.product._id}', this.value)">
        </span>
        <span>$${subtotal.toFixed(2)}
          <button class="remove-btn" onclick="removeFromCart('${item.product._id}')">Remove</button>
        </span>
      `;
      orderSummary.appendChild(div);
    });

    const totalDiv = document.createElement('div');
    totalDiv.classList.add('total');
    totalDiv.innerHTML = `<span>Total</span> <span>$${totalPrice.toFixed(2)}</span>`;
    orderSummary.appendChild(totalDiv);
  }

  async function updateQuantity(productId, quantity) {
    try {
      const res = await fetch(`http://localhost:5000/api/cart/update/${productId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ quantity: Number(quantity) })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Failed to update quantity');
      fetchCart();
    } catch (err) {
      console.error(err);
      showNotification('Something went wrong updating quantity.', 'error');
    }
  }

  async function removeFromCart(productId) {
    try {
      const res = await fetch(`http://localhost:5000/api/cart/remove/${productId}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Failed to remove item');
      fetchCart();
    } catch (err) {
      console.error(err);
      showNotification('Something went wrong removing item.', 'error');
    }
  }

  function showNotification(message, type = 'success') {
    notificationBox.innerText = message;
    notificationBox.className = `notification ${type}`;
    notificationBox.style.display = 'block';

    setTimeout(() => {
      notificationBox.style.display = 'none';
    }, 4000);
  }

  placeOrderBtn.addEventListener('click', async () => {
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();

    if (!name || !phone || !address) {
      showNotification('Please fill in all details!', 'error');
      return;
    }

    try {
      const res = await fetch('http://localhost:5000/api/cart/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({
          paymentMethod: 'COD',
          userDetails: { name, phone, address }
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Failed to place order');

      showNotification(`✅ Order placed successfully! Order ID: ${data.orderId}`, 'success');
      setTimeout(() => window.location.href = 'orders.html', 2000);

    } catch (err) {
      console.error(err);
      showNotification('Something went wrong placing order.', 'error');
    }
  });

  // ✅ Function to manage navbar links dynamically
  function checkAuthNavbar() {
    const token = localStorage.getItem("token");
    const nav = document.querySelector("nav ul");

    if (!nav) return; // if no nav found, skip

    const loginLink = nav.querySelector('a[href="login.html"]')?.parentElement;
    const registerLink = nav.querySelector('a[href="register.html"]')?.parentElement;
    const logoutLink = nav.querySelector('a[href="#logout"]')?.parentElement;

    if (token) {
      // Hide Login & Register
      if (loginLink) loginLink.style.display = "none";
      if (registerLink) registerLink.style.display = "none";

      // Add Logout if not there
      if (!logoutLink) {
        const li = document.createElement("li");
        const logout = document.createElement("a");
        logout.href = "#logout";
        logout.innerText = "Logout";
        logout.addEventListener("click", () => {
          localStorage.removeItem("token");
          alert("Logged out successfully!");
          window.location.reload();
        });
        li.appendChild(logout);
        nav.appendChild(li);
      }
    } else {
      // Show Login & Register again
      if (loginLink) loginLink.style.display = "block";
      if (registerLink) registerLink.style.display = "block";

      // Remove Logout if exists
      if (logoutLink) logoutLink.remove();
    }
  }

  fetchCart();
</script>

</body>
</html>
